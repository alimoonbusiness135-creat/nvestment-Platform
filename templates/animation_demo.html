{% extends 'base.html' %}

{% block title %}Forex Trading Dashboard - Live Markets{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forex_dashboard.css') }}">
<style>
    /* Additional tweaks for the specific animation demo context if needed */
    .flash-message-container {
        z-index: 2000;
    }
</style>
{% endblock %}

{% block content %}
<div class="forex-container animate-level-1">
    <div class="forex-header">
        <div>
            <h1>Forex Live Markets</h1>
            <p class="text-muted">Real-time trading prices and market analysis</p>
        </div>
        <div class="market-status">
            <span class="status-dot"></span>
            <span>Market Open (Live)</span>
        </div>
    </div>

    <div class="forex-grid" id="market-grid">
        <!-- Dashboard cards will be injected here by JS -->
    </div>

    <div class="forex-tools">
        <div class="tool-card animate-level-3">
            <h4><i class="fas fa-chart-line"></i> Market Analysis</h4>
            <p>Our AI-driven algorithms analyze market trends every second to provide you with the most accurate trading
                signals.</p>
            <a href="{{ url_for('market_analysis') }}" class="btn btn-outline-primary btn-sm">View Full Analysis</a>
        </div>
        <div class="tool-card animate-level-4">
            <h4><i class="fas fa-history"></i> Recent Activity</h4>
            <p>Stay updated with the latest trades executed on the platform. High volume detected in <strong>GOLD
                    (XAU/USD)</strong>.</p>
            <button class="btn btn-outline-info btn-sm">Activity Log</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Trading Pairs Configuration
    const tradingPairs = [
        { name: "GOLD", symbol: "xau/usd", price: 2034.45, digits: 2 },
        { name: "EUR/USD", symbol: "eur/usd", price: 1.0845, digits: 4 },
        { name: "GBP/USD", symbol: "gbp/usd", price: 1.2678, digits: 4 },
        { name: "BTC/USD", symbol: "btc/usd", price: 62450.00, digits: 2 },
        { name: "ETH/USD", symbol: "eth/usd", price: 3450.25, digits: 2 },
        { name: "USD/JPY", symbol: "usd/jpy", price: 150.12, digits: 2 },
        { name: "AUD/USD", symbol: "aud/usd", price: 0.6521, digits: 4 },
        { name: "USD/CAD", symbol: "usd/cad", price: 1.3542, digits: 4 },
        { name: "SOL/USD", symbol: "sol/usd", price: 132.45, digits: 2 },
        { name: "BNB/USD", symbol: "bnb/usd", price: 412.30, digits: 2 },
        { name: "GBP/JPY", symbol: "gbp/jpy", price: 190.25, digits: 2 },
        { name: "EUR/JPY", symbol: "eur/jpy", price: 162.80, digits: 2 },
        { name: "NZD/USD", symbol: "nzd/usd", price: 0.6123, digits: 4 },
        { name: "USD/CHF", symbol: "usd/chf", price: 0.8812, digits: 4 },
        { name: "OIL WTI", symbol: "oil/wti", price: 78.45, digits: 2 },
        { name: "NATGAS", symbol: "gas/usd", price: 1.84, digits: 2 },
        { name: "NAS100", symbol: "nas100", price: 18025.50, digits: 2 },
        { name: "US500", symbol: "us500", price: 5088.10, digits: 2 },
        { name: "US30", symbol: "us30", price: 38950.00, digits: 2 },
        { name: "XAG/USD", symbol: "xag/usd", price: 22.85, digits: 2 }
    ];

    const marketGrid = document.getElementById('market-grid');

    // Initialize Dashboard
    function initDashboard() {
        tradingPairs.forEach((pair, index) => {
            const card = document.createElement('div');
            card.className = `trading-pair-card animate-level-${(index % 5) + 2}`;
            card.id = `pair-${pair.symbol.replace('/', '-')}`;

            card.innerHTML = `
                <div class="pair-info">
                    <span class="pair-name">${pair.name}</span>
                    <span class="pair-symbol">${pair.symbol}</span>
                </div>
                <div class="pair-price" id="price-${pair.symbol.replace('/', '-')}">
                    ${pair.price.toFixed(pair.digits)}
                </div>
                <div class="pair-change" id="change-${pair.symbol.replace('/', '-')}">
                    <span class="price-up">+0.00%</span>
                </div>
                <div class="pair-stats">
                    <div class="stat-item">
                        <div class="stat-label">High</div>
                        <div class="stat-value">${(pair.price * 1.002).toFixed(pair.digits)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Low</div>
                        <div class="stat-value">${(pair.price * 0.998).toFixed(pair.digits)}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Vol</div>
                        <div class="stat-value">${(Math.random() * 10).toFixed(1)}M</div>
                    </div>
                </div>
                <div class="trading-controls">
                    <button class="btn btn-trade btn-buy" onclick="handleTrade('${pair.name}', 'buy')">Buy</button>
                    <button class="btn btn-trade btn-sell" onclick="handleTrade('${pair.name}', 'sell')">Sell</button>
                </div>
            `;
            marketGrid.appendChild(card);
        });
    }

    // Handle Trade Action
    window.handleTrade = function (pair, type) {
        const title = type.toUpperCase() + ' Success!';
        const message = `You have successfully executed a ${type} order for ${pair}.`;

        // Use flash message system if available in base.html
        if (typeof createFlashMessage === 'function') {
            const flashContainer = document.getElementById('flashMessages');
            flashContainer.appendChild(createFlashMessage(message, type === 'buy' ? 'success' : 'danger'));
        } else {
            alert(`${title}\n${message}`);
        }
    };

    // Live Price Simulation
    function updatePrices() {
        tradingPairs.forEach(pair => {
            const symbolId = pair.symbol.replace('/', '-');
            const priceEl = document.getElementById(`price-${symbolId}`);
            const changeEl = document.getElementById(`change-${symbolId}`);
            const cardEl = document.getElementById(`pair-${symbolId}`);

            if (!priceEl) return;

            // Random fluctuation
            const volatility = 0.0005; // 0.05%
            const change = (Math.random() - 0.5) * 2 * volatility;
            const oldPrice = pair.price;
            pair.price *= (1 + change);

            // Update UI
            priceEl.textContent = pair.price.toFixed(pair.digits);

            // Dynamic color feedback
            if (pair.price > oldPrice) {
                priceEl.className = 'pair-price price-up';
                cardEl.classList.add('price-tick-up');
                setTimeout(() => cardEl.classList.remove('price-tick-up'), 500);
            } else {
                priceEl.className = 'pair-price price-down';
                cardEl.classList.add('price-tick-down');
                setTimeout(() => cardEl.classList.remove('price-tick-down'), 500);
            }

            // Randomly update change percentage
            const pct = ((Math.random() * 2) - 1).toFixed(2);
            changeEl.innerHTML = `<span class="${pct >= 0 ? 'price-up' : 'price-down'}">${pct >= 0 ? '+' : ''}${pct}%</span>`;
        });
    }

    // Start everything
    initDashboard();
    setInterval(updatePrices, 1500); // Update every 1.5 seconds for visible effect

</script>
{% endblock %}